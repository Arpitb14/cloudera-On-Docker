##################################################################################
##	Author 		: Miztiik
##	Date   		: 07Aug2015
##	Version		: 0.3
##	Description	: Some of the commands to help me quickly execute docker commands
##################################################################################

# Some docker commands

# To List Containers
sudo docker ps –a

# To stop a container
docker stop <container-id>

# Starting a container
# docker run --name <custom-name-of-the-container-to-identify> <name-of-the-container-to-boot> <shell-to-startwith>

docker run -d -ti \
--name hadoopbase \
-p 32769:22 \
--privileged=true \
-v /media/sf_dockerRepos:/media/sf_dockerRepos \
docker.io/centos:6.6 /bin/bash

docker run -d -ti \
--name c2 \
-p 32770:22 \
--privileged=true \
-v /media/sf_dockerRepos:/media/sf_dockerRepos \
local/hadoopbase:v3 /usr/sbin/sshd -D



docker run -ti -d \
--name hadoopmgrnode \
-p 2891:2891 \
-p 32768:22 \
-p 7180:7180 \
--privileged=true \
-v /media/sf_dockerRepos:/media/sf_dockerRepos \
local/hadoopmgrnode:v2 /bin/bash

docker run -d -ti \
--name namenode1 \
-p 32769:22 \
--privileged=true \
-v /media/sf_dockerRepos:/media/sf_dockerRepos \
local/hadoopbase:v1 /bin/bash

docker run -d -ti --hostname=node1 --name node1 local/hadoopbase:v2
docker run -d -ti --hostname=node2 --name node2 local/hadoopbase:v2

docker run -d -ti --name webnode1 -p 80:80 docker.io/httpd:latest
docker run -d -ti --name webnode2 -p 8080:80 docker.io/httpd:latest


weave run 10.128.0.5/10 -d -ti -h webnode1.weave.local --name webnode1 -p 80:80 docker.io/httpd:latest
weave run 10.128.0.6/10 -d -ti -h webnode2.weave.local --name webnode2 -p 8080:80 docker.io/httpd:latest

apache_node1_CID=$(docker run -d -ti --dns=172.17.42.1 \
-h apache_node1 \
--name apache_node1 \
-p 80:80 \
docker.io/httpd:latest)


apache_node2_CID=$(docker run -d -ti --dns=172.17.42.1 \
-h apache_node2 \
--name apache_node2 \
-p 8080:80 \
docker.io/httpd:latest)


basenodeJOB=$(docker run -ti -p :22 -h hadoopbase -v /tmp/repos:/tmp/repos --name hadoopbase local/centos66:latest  /bin/bash -c "while true; do echo Hello world; sleep 1; done")

# To find IP address through scripted means
CID=$(docker run -d stackbrew/ubuntu-upstart)
IPADDR=$(docker inspect --format='{{.NetworkSettings.IPAddress}}' $CID)
docker inspect --format '{{ .NetworkSettings.IPAddress }}' ${CID}

apache_node1
ssh root@$IPADDR


# To commit a change from a container to a image ( Use the -m and -a options to document the image and its author)
# docker commit -m <desc-of-image> -a <author> <container id> <username>/<imagename>:<version>
docker commit -m "centosUpdated + java + ssh" -a "miztiik" 195d6216b120 local/centos66:latest

docker commit -m "Hadoopbase-ssh-yum-cache-on" -a "miztiik" 4fd1a6fb3948 local/hadoopbase:v2

docker commit -m "hadoop-Cloudera-Manager-Base" -a "miztiik" 9528fe20c924 local/hadoop_cloudera_mgr_base:v1

docker commit -m "ClouderaMgrBase-repoHTTPD-2891 port" -a "miztiik" f179c5c863da local/hadoopmgrnode:v2


# To find out information about a container
docker inspect <name>

# To build a container from a image through a script
# docker build --tag "local/centos66-ssh:v2" --file="/Dockerfile"
  docker build --tag="local/hadoopbase:v1" .
  
# To destory a container
# To remove docker images ( In order to remove an image from the host, please make sure that there are no containers actively based on it)
docker rmi <image-id>

# To remove docker container
docker rm <container-id>

# To clone a docker image

/media/sf_dockerRepos


# To backup a image
# docker save docker.io/weaveworks/weaveexec:1.0.1 >  weaveexec.tar
docker save imagename > <custom-image-ref-name>.tar


# To load a image from tar
docker load -t <imagename>:<image-tag> -i <path to image tar file>
docker load < <tar-filename.tar>
docker load < /media/sf_dockerRepos/dockerBckUps/hadoopBasev2.tar

# Tagging names to images in docker
docker tag <image> <newName>/<repoName>:<tagName>
docker tag bc7f541e6b7e local/hadoopbase:v2
hadoopBasev2.tar

# To remove all non running containers
docker stop $(docker ps -a -q)
docker rm $(docker ps -q -f status=exited)

# To solve device mapper errors
service docker stop
thin_check /var/lib/docker/devicemapper/devicemapper/metadata
thin_check --clear-needs-check-flag /var/lib/docker/devicemapper/devicemapper/metadata
service docker start

# Count the thin pools created
thin_dump /var/lib/docker/devicemapper/devicemapper/metadata | grep "device dev_id" | wc -l

# To open a shell in a running container
docker 	 -it <container-id> /bin/bash

# To check container size
du -d 2 -h /var/lib/docker/devicemapper | grep `docker inspect -f "{{.Id}}" <container_name>`

# To remove "<none>" tagged images
docker images | grep "<none>" | awk '{ print "docker rmi " $3 }' | bash

# To see the block devices mounted in Centos 7
lsblk

# To check the dm pool
dmsetup ls
dmsetup status

docker stop $(docker ps -aq)
docker rm $(docker ps -aq)
docker ps -a

systemctl restart docker

docker <watch-what-you-run> rmi $(docker images -q)

